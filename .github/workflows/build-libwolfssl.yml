name: Cross-compile wolfSSL for ImmortalWrt 24.10.1 x64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      wolfssl_version:
        description: 'wolfSSL version to build'
        required: true
        default: 'v5.8.0-stable'
        type: string

env:
  WOLFSSL_VERSION: ${{ inputs.wolfssl_version || 'v5.8.0-stable' }}

jobs:
  cross-compile-x64:
    name: Cross-compile wolfSSL for x64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          wget \
          curl \
          git \
          file \
          unzip \
          zstd \
          xz-utils

    - name: Download wolfSSL source
      run: |
        git clone --depth 1 --branch ${WOLFSSL_VERSION} https://github.com/wolfSSL/wolfssl.git
        cd wolfssl
        ./autogen.sh

    - name: Download ImmortalWrt 24.10.1 x64 SDK
      run: |
        # ä½¿ç”¨ç¡®è®¤çš„ImmortalWrt 24.10.1 x86/64 SDKä¸‹è½½åœ°å€
        SDK_URL="https://downloads.immortalwrt.org/releases/24.10.1/targets/x86/64/immortalwrt-sdk-24.10.1-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        
        echo "Downloading SDK from: $SDK_URL"
        wget -O sdk.tar.zst "$SDK_URL"
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        echo "Downloaded file size: $(stat -c%s sdk.tar.zst) bytes"
        file sdk.tar.zst
        
        # è§£å‹SDK
        echo "Extracting SDK..."
        tar -I zstd -xf sdk.tar.zst
        
        # æŸ¥æ‰¾SDKç›®å½•
        SDK_DIR=$(find . -maxdepth 1 -name "immortalwrt-sdk-*" -type d)
        if [ -z "$SDK_DIR" ]; then
          echo "Error: SDK directory not found"
          ls -la
          exit 1
        fi
        
        echo "SDK_PATH=$(pwd)/$SDK_DIR" >> $GITHUB_ENV
        echo "Found SDK directory: $SDK_DIR"
        
        # éªŒè¯SDKç›®å½•ç»“æ„
        ls -la "$SDK_DIR/"
        ls -la "$SDK_DIR/staging_dir/"

    - name: Setup SDK environment and verify toolchain
      run: |
        cd $SDK_PATH
        
        # æŸ¥æ‰¾æ­£ç¡®çš„å·¥å…·é“¾ç›®å½•
        TOOLCHAIN_DIR=$(find staging_dir -maxdepth 1 -name "toolchain-*" -type d)
        if [ -z "$TOOLCHAIN_DIR" ]; then
          echo "Error: Toolchain directory not found"
          ls -la staging_dir/
          exit 1
        fi
        
        echo "Found toolchain directory: $TOOLCHAIN_DIR"
        TOOLCHAIN_PATH="$SDK_PATH/$TOOLCHAIN_DIR"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "STAGING_DIR=$SDK_PATH/staging_dir" >> $GITHUB_ENV
        echo "TOOLCHAIN_PATH=$TOOLCHAIN_PATH" >> $GITHUB_ENV
        echo "PATH=$TOOLCHAIN_PATH/bin:$PATH" >> $GITHUB_ENV
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾å˜é‡
        echo "CC=x86_64-openwrt-linux-musl-gcc" >> $GITHUB_ENV
        echo "CXX=x86_64-openwrt-linux-musl-g++" >> $GITHUB_ENV
        echo "AR=x86_64-openwrt-linux-musl-ar" >> $GITHUB_ENV
        echo "RANLIB=x86_64-openwrt-linux-musl-ranlib" >> $GITHUB_ENV
        echo "STRIP=x86_64-openwrt-linux-musl-strip" >> $GITHUB_ENV
        echo "LD=x86_64-openwrt-linux-musl-ld" >> $GITHUB_ENV
        echo "CROSS_COMPILE=x86_64-openwrt-linux-musl-" >> $GITHUB_ENV
        
        # éªŒè¯å·¥å…·é“¾
        echo "Verifying toolchain..."
        ls -la "$TOOLCHAIN_PATH/bin/"
        
        # æµ‹è¯•ç¼–è¯‘å™¨
        export PATH="$TOOLCHAIN_PATH/bin:$PATH"
        x86_64-openwrt-linux-musl-gcc --version
        echo "Toolchain verification completed successfully"

    - name: Configure wolfSSL build
      working-directory: wolfssl
      run: |
        export PATH="$TOOLCHAIN_PATH/bin:$PATH"
        export STAGING_DIR="$SDK_PATH/staging_dir"
        
        # è®¾ç½®ImmortalWrtç‰¹å®šçš„ç¼–è¯‘æ ‡å¿—
        CFLAGS="-Os -pipe -fno-caller-saves -fno-plt -fhonour-copts -Wno-error=unused-but-set-variable -Wno-error=unused-result -fstack-protector -D_FORTIFY_SOURCE=1"
        CXXFLAGS="$CFLAGS"
        LDFLAGS="-fstack-protector"
        
        # é…ç½®wolfSSLï¼Œç§»é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„é€‰é¡¹
        ./configure \
          --host=x86_64-openwrt-linux-musl \
          --target=x86_64-openwrt-linux-musl \
          --build=x86_64-pc-linux-gnu \
          --prefix=/usr \
          --exec-prefix=/usr \
          --bindir=/usr/bin \
          --sbindir=/usr/sbin \
          --libexecdir=/usr/lib \
          --sysconfdir=/etc \
          --datadir=/usr/share \
          --localstatedir=/var \
          --mandir=/usr/man \
          --infodir=/usr/info \
          --disable-shared \
          --enable-static \
          --enable-singlethreaded \
          --enable-opensslextra \
          --enable-opensslall \
          --enable-secure-renegotiation \
          --enable-supportedcurves \
          --enable-fortress \
          --enable-fastmath \
          --enable-ecc \
          --enable-aesgcm \
          --enable-chacha \
          --enable-poly1305 \
          --enable-sha3 \
          --enable-curve25519 \
          --enable-ed25519 \
          --enable-keygen \
          --enable-certgen \
          --enable-certreq \
          --enable-certext \
          --enable-sessioncerts \
          --enable-sni \
          --enable-alpn \
          --disable-examples \
          --disable-crypttests \
          --disable-oldtls \
          --disable-shared \
          CC=x86_64-openwrt-linux-musl-gcc \
          CXX=x86_64-openwrt-linux-musl-g++ \
          AR=x86_64-openwrt-linux-musl-ar \
          RANLIB=x86_64-openwrt-linux-musl-ranlib \
          STRIP=x86_64-openwrt-linux-musl-strip \
          CFLAGS="$CFLAGS" \
          CXXFLAGS="$CXXFLAGS" \
          LDFLAGS="$LDFLAGS"

    - name: Build wolfSSL
      working-directory: wolfssl
      run: |
        export PATH="$TOOLCHAIN_PATH/bin:$PATH"
        export STAGING_DIR="$SDK_PATH/staging_dir"
        
        echo "Starting wolfSSL build..."
        make -j$(nproc) V=s
        
        echo "Installing wolfSSL..."
        make DESTDIR=$PWD/install install
        
        # éªŒè¯æ„å»ºç»“æœ
        echo "Build completed. Checking installed files:"
        find install -name "libwolfssl*" -exec ls -la {} \;

    - name: Create deployment package
      working-directory: wolfssl
      run: |
        export PATH="$TOOLCHAIN_PATH/bin:$PATH"
        
        # åˆ›å»ºåŒ…ç›®å½•ç»“æ„
        mkdir -p package/usr/lib
        mkdir -p package/usr/include
        mkdir -p package/usr/bin
        
        # å¤åˆ¶åº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶
        if [ -d "install/usr/lib" ]; then
          cp -av install/usr/lib/* package/usr/lib/ 2>/dev/null || true
        fi
        if [ -d "install/usr/include" ]; then
          cp -av install/usr/include/* package/usr/include/ 2>/dev/null || true
        fi
        if [ -d "install/usr/bin" ]; then
          cp -av install/usr/bin/* package/usr/bin/ 2>/dev/null || true
        fi
        
        # å»é™¤è°ƒè¯•ä¿¡æ¯ä»¥å‡å°ä½“ç§¯
        find package -name "*.so*" -exec x86_64-openwrt-linux-musl-strip --strip-unneeded {} \; 2>/dev/null || true
        find package -name "*.a" -exec x86_64-openwrt-linux-musl-strip --strip-debug {} \; 2>/dev/null || true
        find package -type f -executable -exec x86_64-openwrt-linux-musl-strip --strip-all {} \; 2>/dev/null || true
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        mkdir -p scripts
        cat > scripts/install.sh << 'EOF'
        #!/bin/sh
        echo "Installing wolfSSL for ImmortalWrt 24.10.1..."
        
        # å¤‡ä»½ç°æœ‰åº“
        if [ -f /usr/lib/libwolfssl.so ]; then
            cp /usr/lib/libwolfssl.so /usr/lib/libwolfssl.so.backup 2>/dev/null || true
            echo "Existing library backed up"
        fi
        
        # å¤åˆ¶æ–°åº“æ–‡ä»¶
        cp -r usr/* /usr/
        
        # æ›´æ–°åŠ¨æ€é“¾æ¥åº“ç¼“å­˜
        ldconfig 2>/dev/null || true
        
        # é‡å¯strongswanæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f /etc/init.d/strongswan ]; then
            echo "Restarting strongswan service..."
            /etc/init.d/strongswan restart 2>/dev/null || true
        fi
        
        echo "wolfSSL installation completed successfully"
        EOF
        
        chmod +x scripts/install.sh
        
        # åˆ›å»ºæœ€ç»ˆçš„tarballåŒ…
        tar -czf wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz -C package .
        
        # åˆ›å»ºåŒ…å«å®‰è£…è„šæœ¬çš„å®Œæ•´åŒ…
        mkdir -p full-package
        cp -r package/* full-package/
        cp scripts/install.sh full-package/
        tar -czf wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz -C full-package .
        
        # æ˜¾ç¤ºåŒ…ä¿¡æ¯
        echo "=== Package Contents ==="
        find package -type f | head -20
        echo "=== Package Sizes ==="
        ls -lah wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64*.tar.gz

    - name: Test compiled libraries
      working-directory: wolfssl
      run: |
        export PATH="$TOOLCHAIN_PATH/bin:$PATH"
        
        echo "=== Testing library symbols ==="
        # æ£€æŸ¥å…³é”®ç¬¦å·æ˜¯å¦å­˜åœ¨
        if [ -f "package/usr/lib/libwolfssl.a" ]; then
          echo "Checking symbols in static library..."
          x86_64-openwrt-linux-musl-nm package/usr/lib/libwolfssl.a | grep -E "(wolfssl_ec_diffie_hellman|wolfSSL_Init|wolfSSL_CTX_new)" || echo "Some symbols might be in different format"
        fi
        
        if [ -f "package/usr/lib/libwolfssl.so" ]; then
          echo "Checking shared library..."
          file package/usr/lib/libwolfssl.so
          x86_64-openwrt-linux-musl-readelf -d package/usr/lib/libwolfssl.so 2>/dev/null || true
        fi
        
        echo "Library testing completed"

    - name: Generate build report
      working-directory: wolfssl
      run: |
        echo "# wolfSSL ${WOLFSSL_VERSION} æ„å»ºæŠ¥å‘Š - ImmortalWrt 24.10.1 x64" > build-report.md
        echo "" >> build-report.md
        echo "## æ„å»ºä¿¡æ¯" >> build-report.md
        echo "- wolfSSLç‰ˆæœ¬: ${WOLFSSL_VERSION}" >> build-report.md
        echo "- ç›®æ ‡ç³»ç»Ÿ: ImmortalWrt 24.10.1" >> build-report.md
        echo "- ç›®æ ‡æ¶æ„: x86_64" >> build-report.md
        echo "- ç¼–è¯‘å™¨: GCC 13.3.0 with musl libc" >> build-report.md
        echo "- æ„å»ºæ—¥æœŸ: $(date)" >> build-report.md
        echo "- æ„å»ºä¸»æœº: $(uname -a)" >> build-report.md
        echo "" >> build-report.md
        echo "## å¯ç”¨çš„åŠŸèƒ½ç‰¹æ€§" >> build-report.md
        echo "- âœ… OpenSSLå…¼å®¹å±‚ (opensslextra, opensslall)" >> build-report.md
        echo "- âœ… ç°ä»£åŠ å¯†ç®—æ³• (ECC, AES-GCM, ChaCha20, Poly1305)" >> build-report.md
        echo "- âœ… TLS 1.3å’Œé«˜çº§ç‰¹æ€§ (Curve25519, Ed25519, SHA-3)" >> build-report.md
        echo "- âœ… è¯ä¹¦åŠŸèƒ½ (è¯ä¹¦ç”Ÿæˆã€å¯†é’¥ç”Ÿæˆã€è¯ä¹¦è¯·æ±‚)" >> build-report.md
        echo "- âœ… ä¼šè¯ç®¡ç† (SNI, ALPN, ä¼šè¯è¯ä¹¦)" >> build-report.md
        echo "- âœ… å®‰å…¨åŠ å›º (å®‰å…¨é‡åå•†ã€æ”¯æŒçš„æ›²çº¿)" >> build-report.md
        echo "- âœ… å•çº¿ç¨‹æ¨¡å¼ (é€‚åˆåµŒå…¥å¼ç¯å¢ƒ)" >> build-report.md
        echo "" >> build-report.md
        echo "## å¿«é€Ÿå®‰è£…" >> build-report.md
        echo "### æ–¹æ³•1ï¼šè‡ªåŠ¨å®‰è£…è„šæœ¬" >> build-report.md
        echo "1. ä¸‹è½½ \`wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz\`" >> build-report.md
        echo "2. åœ¨ImmortalWrtç³»ç»Ÿä¸­æ‰§è¡Œ:" >> build-report.md
        echo "   \`\`\`bash" >> build-report.md
        echo "   tar -xzf wolfssl-*-with-installer.tar.gz" >> build-report.md
        echo "   chmod +x install.sh" >> build-report.md
        echo "   ./install.sh" >> build-report.md
        echo "   \`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "### æ–¹æ³•2ï¼šæ‰‹åŠ¨å®‰è£…" >> build-report.md
        echo "1. ä¸‹è½½ \`wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz\`" >> build-report.md
        echo "2. åœ¨ImmortalWrtç³»ç»Ÿä¸­æ‰§è¡Œ:" >> build-report.md
        echo "   \`\`\`bash" >> build-report.md
        echo "   tar -xzf wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz -C /" >> build-report.md
        echo "   ldconfig" >> build-report.md
        echo "   /etc/init.d/strongswan restart" >> build-report.md
        echo "   \`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "## é—®é¢˜ä¿®å¤" >> build-report.md
        echo "æ­¤ç‰ˆæœ¬ä¸“é—¨è§£å†³ä»¥ä¸‹strongswané”™è¯¯:" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "plugin 'wolfssl' failed to load: Error relocating" >> build-report.md
        echo "/usr/lib/ipsec/plugins/libstrongswan-wolfssl.so:" >> build-report.md
        echo "wolfssl_ec_diffie_hellman_create: symbol not found" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "## æ•…éšœæ’é™¤" >> build-report.md
        echo "å¦‚æœå®‰è£…åä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥:" >> build-report.md
        echo "1. éªŒè¯åº“æ–‡ä»¶: \`ls -la /usr/lib/libwolfssl*\`" >> build-report.md
        echo "2. æ£€æŸ¥ç¬¦å·: \`nm /usr/lib/libwolfssl.a | grep wolfssl_ec\`" >> build-report.md
        echo "3. æŸ¥çœ‹æ—¥å¿—: \`logread | grep strongswan\`" >> build-report.md
        echo "4. é‡å¯æœåŠ¡: \`/etc/init.d/strongswan restart\`" >> build-report.md

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wolfssl-immortalwrt-24.10.1-x86_64-${{ env.WOLFSSL_VERSION }}
        path: |
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz
          wolfssl/build-report.md
        retention-days: 30

    - name: Create release assets (if release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz
          wolfssl/build-report.md
        body: |
          ## ğŸš€ wolfSSL ${{ env.WOLFSSL_VERSION }} for ImmortalWrt 24.10.1 x64
          
          **ä¸“ä¸ºImmortalWrt 24.10.1 x86_64æ¶æ„ä¼˜åŒ–ç¼–è¯‘çš„wolfSSLåº“ï¼Œå½»åº•è§£å†³strongswanæ’ä»¶ç¬¦å·ç¼ºå¤±é—®é¢˜ã€‚**
          
          ### âœ… ä¸»è¦ä¿®å¤
          - ğŸ”§ ä¿®å¤äº† `wolfssl_ec_diffie_hellman_create` ç¬¦å·ç¼ºå¤±é—®é¢˜
          - ğŸ› ï¸ ä½¿ç”¨æ­£ç¡®çš„ImmortalWrt 24.10.1å®˜æ–¹SDKå’ŒGCC 13.3.0å·¥å…·é“¾
          - âš¡ ä¼˜åŒ–äº†æ„å»ºé…ç½®ï¼Œç§»é™¤ä¸å…¼å®¹é€‰é¡¹
          - ğŸ”’ å¯ç”¨å•çº¿ç¨‹æ¨¡å¼ï¼Œæé«˜åµŒå…¥å¼ç³»ç»Ÿç¨³å®šæ€§
          
          ### ğŸ“¦ ä¸‹è½½é€‰é¡¹
          - **æ¨è**: `wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz` (åŒ…å«è‡ªåŠ¨å®‰è£…è„šæœ¬)
          - **æ‰‹åŠ¨**: `wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz` (ä»…åº“æ–‡ä»¶)
          
          ### ğŸš€ å¿«é€Ÿå®‰è£…
          ```
          # ä¸‹è½½å¸¦å®‰è£…è„šæœ¬çš„ç‰ˆæœ¬
          wget wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64-with-installer.tar.gz
          tar -xzf wolfssl-*-with-installer.tar.gz
          chmod +x install.sh && ./install.sh
          ```
          
          ### ğŸ’¡ åŠŸèƒ½ç‰¹æ€§
          - å®Œæ•´OpenSSLå…¼å®¹å±‚ï¼Œæ— ç¼æ›¿æ¢ç°æœ‰wolfSSL
          - æ”¯æŒæ‰€æœ‰ç°ä»£åŠ å¯†ç®—æ³•å’ŒTLS 1.3
          - é’ˆå¯¹ImmortalWrt 24.10.1ä¼˜åŒ–çš„ç¼–è¯‘å‚æ•°
          - åŒ…å«strongswanæ‰€éœ€çš„æ‰€æœ‰ç¬¦å·å’Œå‡½æ•°
          
          ### â“ æ”¯æŒ
          é‡åˆ°é—®é¢˜è¯·æŸ¥çœ‹åŒ…å«çš„ `build-report.md` è·å–è¯¦ç»†å®‰è£…è¯´æ˜å’Œæ•…éšœæ’é™¤æŒ‡å—ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
