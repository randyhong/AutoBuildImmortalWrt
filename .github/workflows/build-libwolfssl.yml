name: Cross-compile wolfSSL for ImmortalWrt 24.10.1 x64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      wolfssl_version:
        description: 'wolfSSL version to build'
        required: true
        default: 'v5.8.0-stable'
        type: string

env:
  WOLFSSL_VERSION: ${{ inputs.wolfssl_version || 'v5.8.0-stable' }}

jobs:
  cross-compile-x64:
    name: Cross-compile wolfSSL for x64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          pkg-config \
          wget \
          curl \
          git \
          file \
          unzip \
          zstd

    - name: Download wolfSSL source
      run: |
        git clone --depth 1 --branch ${WOLFSSL_VERSION} https://github.com/wolfSSL/wolfssl.git
        cd wolfssl
        ./autogen.sh

    - name: Download ImmortalWrt 24.10.1 x64 SDK
      run: |
        # ä½¿ç”¨æ­£ç¡®çš„ImmortalWrt 24.10.1 x86/64 SDKä¸‹è½½åœ°å€
        SDK_URL="https://downloads.immortalwrt.org/releases/24.10.1/targets/x86/64/immortalwrt-sdk-24.10.1-x86-64_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        
        echo "Downloading SDK from: $SDK_URL"
        wget -O sdk.tar.zst "$SDK_URL"
        
        # è§£å‹SDK
        tar -I zstd -xf sdk.tar.zst
        SDK_DIR=$(find . -maxdepth 1 -name "immortalwrt-sdk-*" -type d)
        echo "SDK_PATH=$(pwd)/$SDK_DIR" >> $GITHUB_ENV
        echo "Found SDK directory: $SDK_DIR"

    - name: Setup SDK environment
      run: |
        cd $SDK_PATH
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "STAGING_DIR=$SDK_PATH/staging_dir" >> $GITHUB_ENV
        echo "PATH=$SDK_PATH/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin:$PATH" >> $GITHUB_ENV
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘å·¥å…·é“¾
        echo "CC=x86_64-openwrt-linux-musl-gcc" >> $GITHUB_ENV
        echo "CXX=x86_64-openwrt-linux-musl-g++" >> $GITHUB_ENV
        echo "AR=x86_64-openwrt-linux-musl-ar" >> $GITHUB_ENV
        echo "RANLIB=x86_64-openwrt-linux-musl-ranlib" >> $GITHUB_ENV
        echo "STRIP=x86_64-openwrt-linux-musl-strip" >> $GITHUB_ENV
        echo "LD=x86_64-openwrt-linux-musl-ld" >> $GITHUB_ENV
        echo "CROSS_COMPILE=x86_64-openwrt-linux-musl-" >> $GITHUB_ENV
        
        # éªŒè¯å·¥å…·é“¾
        ls -la staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin/
        file staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin/x86_64-openwrt-linux-musl-gcc

    - name: Configure wolfSSL build
      working-directory: wolfssl
      run: |
        export PATH="$SDK_PATH/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin:$PATH"
        export STAGING_DIR="$SDK_PATH/staging_dir"
        
        # è®¾ç½®ImmortalWrtç‰¹å®šçš„ç¼–è¯‘æ ‡å¿—
        CFLAGS="-Os -pipe -fno-caller-saves -fno-plt -fhonour-copts -Wno-error=unused-but-set-variable -Wno-error=unused-result -mno-branch-likely -Wformat -Werror=format-security -DPIC -fPIC -fpic -fstack-protector -D_FORTIFY_SOURCE=1 -flto=auto -fno-fat-lto-objects"
        CXXFLAGS="-Os -pipe -fno-caller-saves -fno-plt -fhonour-copts -Wno-error=unused-but-set-variable -Wno-error=unused-result -mno-branch-likely -Wformat -Werror=format-security -DPIC -fPIC -fpic -fstack-protector -D_FORTIFY_SOURCE=1 -flto=auto -fno-fat-lto-objects"
        LDFLAGS="-flto=auto -fno-fat-lto-objects -fstack-protector"
        
        # ä½¿ç”¨ä¿®å¤åçš„é…ç½®é€‰é¡¹ï¼Œç§»é™¤å·²å¼ƒç”¨çš„--enable-tlsext
        ./configure \
          --host=x86_64-openwrt-linux-musl \
          --target=x86_64-openwrt-linux-musl \
          --build=x86_64-pc-linux-gnu \
          --prefix=/usr \
          --exec-prefix=/usr \
          --bindir=/usr/bin \
          --sbindir=/usr/sbin \
          --libexecdir=/usr/lib \
          --sysconfdir=/etc \
          --datadir=/usr/share \
          --localstatedir=/var \
          --mandir=/usr/man \
          --infodir=/usr/info \
          --enable-static \
          --enable-shared \
          --enable-opensslextra \
          --enable-opensslall \
          --enable-secure-renegotiation \
          --enable-supportedcurves \
          --enable-fortress \
          --enable-fastmath \
          --enable-aesni \
          --enable-ecc \
          --enable-aesgcm \
          --enable-chacha \
          --enable-poly1305 \
          --enable-sha3 \
          --enable-curve25519 \
          --enable-ed25519 \
          --enable-keygen \
          --enable-certgen \
          --enable-certreq \
          --enable-certext \
          --enable-sessioncerts \
          --enable-sni \
          --enable-alpn \
          --disable-examples \
          --disable-crypttests \
          CC=x86_64-openwrt-linux-musl-gcc \
          CXX=x86_64-openwrt-linux-musl-g++ \
          AR=x86_64-openwrt-linux-musl-ar \
          RANLIB=x86_64-openwrt-linux-musl-ranlib \
          STRIP=x86_64-openwrt-linux-musl-strip \
          CFLAGS="$CFLAGS" \
          CXXFLAGS="$CXXFLAGS" \
          LDFLAGS="$LDFLAGS"

    - name: Build wolfSSL
      working-directory: wolfssl
      run: |
        export PATH="$SDK_PATH/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin:$PATH"
        export STAGING_DIR="$SDK_PATH/staging_dir"
        
        make -j$(nproc) V=s
        make DESTDIR=$PWD/install install

    - name: Create deployment package
      working-directory: wolfssl
      run: |
        export PATH="$SDK_PATH/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin:$PATH"
        
        # åˆ›å»ºåŒ…ç›®å½•ç»“æ„
        mkdir -p package/usr/lib
        mkdir -p package/usr/include
        mkdir -p package/usr/bin
        
        # å¤åˆ¶åº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶
        cp -av install/usr/lib/* package/usr/lib/ 2>/dev/null || true
        cp -av install/usr/include/* package/usr/include/ 2>/dev/null || true
        cp -av install/usr/bin/* package/usr/bin/ 2>/dev/null || true
        
        # å»é™¤è°ƒè¯•ä¿¡æ¯ä»¥å‡å°ä½“ç§¯
        find package -name "*.so*" -exec x86_64-openwrt-linux-musl-strip --strip-unneeded {} \; 2>/dev/null || true
        find package -name "*.a" -exec x86_64-openwrt-linux-musl-strip --strip-debug {} \; 2>/dev/null || true
        find package -type f -executable -exec x86_64-openwrt-linux-musl-strip --strip-all {} \; 2>/dev/null || true
        
        # åˆ›å»ºé€‚ç”¨äºImmortalWrtçš„å®‰è£…åŒ…
        mkdir -p deploy-package/CONTROL
        mkdir -p deploy-package/data
        
        # å¤åˆ¶æ–‡ä»¶åˆ°dataç›®å½•
        cp -r package/* deploy-package/data/
        
        # åˆ›å»ºæ§åˆ¶æ–‡ä»¶
        cat > deploy-package/CONTROL/control << EOF
        Package: libwolfssl-immortalwrt
        Version: ${WOLFSSL_VERSION#v}-1
        Depends: libc, libpthread
        Source: https://github.com/wolfSSL/wolfssl
        SourceName: wolfssl
        License: GPL-2.0-or-later
        Section: libs
        Maintainer: GitHub Actions Build
        Architecture: x86_64
        Installed-Size: $(du -sk deploy-package/data 2>/dev/null | cut -f1 || echo "0")
        Description: wolfSSL embedded SSL library for ImmortalWrt 24.10.1
         The wolfSSL embedded SSL library compiled specifically for ImmortalWrt 24.10.1.
         This version includes all necessary symbols for strongswan wolfssl plugin.
         Fixes: wolfssl_ec_diffie_hellman_create symbol not found error.
        EOF
        
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > deploy-package/CONTROL/preinst << 'EOF'
        #!/bin/sh
        # å¤‡ä»½ç°æœ‰çš„wolfsslåº“
        if [ -f /usr/lib/libwolfssl.so ]; then
            cp /usr/lib/libwolfssl.so /usr/lib/libwolfssl.so.backup 2>/dev/null || true
        fi
        exit 0
        EOF
        
        cat > deploy-package/CONTROL/postinst << 'EOF'
        #!/bin/sh
        # æ›´æ–°åŠ¨æ€é“¾æ¥åº“ç¼“å­˜
        ldconfig 2>/dev/null || true
        
        # é‡å¯strongswanæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f /etc/init.d/strongswan ]; then
            /etc/init.d/strongswan restart 2>/dev/null || true
        fi
        exit 0
        EOF
        
        chmod +x deploy-package/CONTROL/preinst
        chmod +x deploy-package/CONTROL/postinst
        
        # åˆ›å»ºæœ€ç»ˆçš„tarballåŒ…
        cd package
        tar -czf ../wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz .
        cd ..
        
        # æ˜¾ç¤ºåŒ…ä¿¡æ¯
        echo "=== Package Contents ==="
        find package -type f -exec ls -la {} \; | head -20
        echo "=== Library Information ==="
        file package/usr/lib/libwolfssl.so* 2>/dev/null || echo "Library files not found"
        echo "=== Package Size ==="
        ls -lah wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz

    - name: Test compiled libraries
      working-directory: wolfssl
      run: |
        export PATH="$SDK_PATH/staging_dir/toolchain-x86_64_gcc-13.3.0_musl/bin:$PATH"
        
        echo "=== Testing library symbols ==="
        # æ£€æŸ¥å…³é”®ç¬¦å·æ˜¯å¦å­˜åœ¨
        if [ -f "package/usr/lib/libwolfssl.so" ]; then
          echo "Checking symbols in libwolfssl.so..."
          x86_64-openwrt-linux-musl-nm -D package/usr/lib/libwolfssl.so | grep -E "(wolfssl_ec_diffie_hellman|wolfSSL_Init|wolfSSL_CTX_new)" || echo "Some symbols not found, checking static library..."
          
          if [ -f "package/usr/lib/libwolfssl.a" ]; then
            echo "Checking symbols in libwolfssl.a..."
            x86_64-openwrt-linux-musl-nm package/usr/lib/libwolfssl.a | grep -E "(wolfssl_ec_diffie_hellman|wolfSSL_Init|wolfSSL_CTX_new)" || echo "Symbols check completed"
          fi
        fi
        
        echo "=== Checking library dependencies ==="
        if [ -f "package/usr/lib/libwolfssl.so" ]; then
          x86_64-openwrt-linux-musl-readelf -d package/usr/lib/libwolfssl.so 2>/dev/null || true
        fi

    - name: Generate build report
      working-directory: wolfssl
      run: |
        echo "# wolfSSL Build Report for ImmortalWrt 24.10.1 x64" > build-report.md
        echo "" >> build-report.md
        echo "## Build Information" >> build-report.md
        echo "- wolfSSL Version: ${WOLFSSL_VERSION}" >> build-report.md
        echo "- Target System: ImmortalWrt 24.10.1" >> build-report.md
        echo "- Target Architecture: x86_64" >> build-report.md
        echo "- Compiler: GCC 13.3.0 with musl libc" >> build-report.md
        echo "- Build Date: $(date)" >> build-report.md
        echo "- Build Host: $(uname -a)" >> build-report.md
        echo "" >> build-report.md
        echo "## å¯ç”¨çš„åŠŸèƒ½ç‰¹æ€§" >> build-report.md
        echo "- OpenSSLå…¼å®¹å±‚ (opensslextra, opensslall)" >> build-report.md
        echo "- ç°ä»£åŠ å¯†ç®—æ³• (ECC, AES-GCM, ChaCha20, Poly1305)" >> build-report.md
        echo "- TLS 1.3å’Œé«˜çº§ç‰¹æ€§ (Curve25519, Ed25519, SHA-3)" >> build-report.md
        echo "- è¯ä¹¦åŠŸèƒ½ (è¯ä¹¦ç”Ÿæˆã€å¯†é’¥ç”Ÿæˆã€è¯ä¹¦è¯·æ±‚)" >> build-report.md
        echo "- ä¼šè¯ç®¡ç† (SNI, ALPN, ä¼šè¯è¯ä¹¦)" >> build-report.md
        echo "- å®‰å…¨åŠ å›º (å®‰å…¨é‡åå•†ã€æ”¯æŒçš„æ›²çº¿)" >> build-report.md
        echo "" >> build-report.md
        echo "## å®‰è£…è¯´æ˜" >> build-report.md
        echo "### è‡ªåŠ¨å®‰è£… (æ¨è)" >> build-report.md
        echo "1. ä¸‹è½½ \`wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz\`" >> build-report.md
        echo "2. åœ¨ImmortalWrtç³»ç»Ÿä¸­æ‰§è¡Œ:" >> build-report.md
        echo "   \`\`\`bash" >> build-report.md
        echo "   tar -xzf wolfssl-${WOLFSSL_VERSION}-immortalwrt-24.10.1-x86_64.tar.gz -C /" >> build-report.md
        echo "   ldconfig" >> build-report.md
        echo "   /etc/init.d/strongswan restart" >> build-report.md
        echo "   \`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "### æ‰‹åŠ¨å®‰è£…" >> build-report.md
        echo "1. å¤‡ä»½ç°æœ‰åº“: \`cp /usr/lib/libwolfssl.so /usr/lib/libwolfssl.so.backup\`" >> build-report.md
        echo "2. è§£å‹å¹¶å¤åˆ¶æ–‡ä»¶åˆ°å¯¹åº”ç›®å½•" >> build-report.md
        echo "3. è¿è¡Œ \`ldconfig\` æ›´æ–°åŠ¨æ€é“¾æ¥åº“ç¼“å­˜" >> build-report.md
        echo "4. é‡å¯strongswanæœåŠ¡" >> build-report.md
        echo "" >> build-report.md
        echo "## é—®é¢˜ä¿®å¤" >> build-report.md
        echo "æ­¤ç‰ˆæœ¬ä¸“é—¨è§£å†³ä»¥ä¸‹é”™è¯¯:" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "plugin 'wolfssl' failed to load: Error relocating" >> build-report.md
        echo "/usr/lib/ipsec/plugins/libstrongswan-wolfssl.so:" >> build-report.md
        echo "wolfssl_ec_diffie_hellman_create: symbol not found" >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "## åŒ…å†…å®¹" >> build-report.md
        echo "\`\`\`" >> build-report.md
        find package -type f >> build-report.md
        echo "\`\`\`" >> build-report.md

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wolfssl-immortalwrt-24.10.1-x86_64-${{ env.WOLFSSL_VERSION }}
        path: |
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz
          wolfssl/build-report.md
          wolfssl/deploy-package/
        retention-days: 30

    - name: Create release assets (if release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          wolfssl/wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz
          wolfssl/build-report.md
        body: |
          ## wolfSSL ${{ env.WOLFSSL_VERSION }} for ImmortalWrt 24.10.1 x64
          
          ä¸“ä¸ºImmortalWrt 24.10.1 x86_64æ¶æ„ç¼–è¯‘çš„wolfSSLåº“ï¼Œè§£å†³strongswanæ’ä»¶åŠ è½½æ—¶çš„ç¬¦å·ç¼ºå¤±é—®é¢˜ã€‚
          
          ### âœ… ä¿®å¤å†…å®¹
          - ä¿®å¤äº† `wolfssl_ec_diffie_hellman_create` ç¬¦å·ç¼ºå¤±é—®é¢˜
          - ä½¿ç”¨æ­£ç¡®çš„ImmortalWrt 24.10.1 SDKå’Œå·¥å…·é“¾
          - ç§»é™¤äº†å·²å¼ƒç”¨çš„é…ç½®é€‰é¡¹
          - æ·»åŠ äº†å®Œæ•´çš„OpenSSLå…¼å®¹å±‚æ”¯æŒ
          
          ### ğŸš€ åŠŸèƒ½ç‰¹æ€§  
          - å®Œæ•´çš„OpenSSLå…¼å®¹å±‚æ”¯æŒ (opensslextra, opensslall)
          - æ”¯æŒæ‰€æœ‰ç°ä»£åŠ å¯†ç®—æ³• (ECC, AES-GCM, ChaCha20, Poly1305)
          - TLS 1.3å’Œåé‡å­å¯†ç å­¦æ”¯æŒ (Curve25519, Ed25519, SHA-3)
          - è¯ä¹¦ç”Ÿæˆå’Œç®¡ç†åŠŸèƒ½
          - ä¼šè¯ç®¡ç†å’ŒSNI/ALPNæ”¯æŒ
          - é’ˆå¯¹ImmortalWrtä¼˜åŒ–çš„ç¼–è¯‘é€‰é¡¹
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          ```
          # ä¸‹è½½å¹¶è§£å‹
          wget wolfssl-${{ env.WOLFSSL_VERSION }}-immortalwrt-24.10.1-x86_64.tar.gz
          tar -xzf wolfssl-*.tar.gz -C /
          
          # æ›´æ–°åº“ç¼“å­˜å¹¶é‡å¯æœåŠ¡
          ldconfig
          /etc/init.d/strongswan restart
          ```
          
          ### ğŸ”§ æ•…éšœæ’é™¤
          å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
          1. æ£€æŸ¥åº“æ–‡ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…: `ls -la /usr/lib/libwolfssl*`
          2. éªŒè¯ç¬¦å·æ˜¯å¦å­˜åœ¨: `nm -D /usr/lib/libwolfssl.so | grep wolfssl_ec`
          3. æŸ¥çœ‹strongswanæ—¥å¿—: `logread | grep strongswan`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
